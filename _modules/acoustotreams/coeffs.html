<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>acoustotreams.coeffs &#8212; acoustotreams 0.2.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=0c472235" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css?v=424f8d56" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4ec84db" />
    <script src="../../_static/documentation_options.js?v=37f418d5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">acoustotreams 0.2.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acoustotreams.coeffs</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for acoustotreams.coeffs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Scattering coefficients for high-symmetry cases.</span>

<span class="sd">Calculate the scattering coefficients for cases where they can be obtained analytically</span>
<span class="sd">easily. This is a (multilayered) sphere using spherical waves (Mie coefficients), </span>
<span class="sd">a cylinder using cylindrical waves, and an infinitely extended planar</span>
<span class="sd">interface (Fresnel coefficients).</span>

<span class="sd">.. autosummary::</span>
<span class="sd">   :toctree:</span>

<span class="sd">   mie_acoustics</span>
<span class="sd">   mie_acoustics_cyl</span>
<span class="sd">   fresnel_acoustics</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">treams.special</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._materialacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcousticMaterial</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_mie_acoustics_iter</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mat_sphere</span><span class="p">,</span> <span class="n">mat_env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve a matrix for the boundary conditions at a spherical interface.</span>

<span class="sd">    Six types of interfaces are supported: fluid-fluid, fluid-solid, solid-fluid,</span>
<span class="sd">    solid-solid, soft-fluid, and hard-fluid.</span>

<span class="sd">    The fluid medium has :math:`(\rho, c, c_t = 0)`, the solid medium has</span>
<span class="sd">    :math:`(\rho, c, c_t)`, the soft medium has :math:`(\rho = 0, c = 0, c_t = 0)`,</span>
<span class="sd">    and the hard medium has :math:`(\rho = \infty, c = 0, c_t = 0)`.</span>

<span class="sd">    Note:</span>
<span class="sd">        The order of coefficients is LL, NL, LN, and NN.</span>

<span class="sd">    Args:</span>
<span class="sd">        tm: T-matrix of the previous layer.</span>
<span class="sd">        l: Degree of the coefficient.</span>
<span class="sd">        x: Size parameters in the air.</span>
<span class="sd">        mat_sphere: Material of the sphere :math:`(\rho, c, c_t)`.</span>
<span class="sd">        mat_env: Material of the medium :math:`(\rho, c, c_t)`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        complex 4-array</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">x_env</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> 
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> 
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">j</span> <span class="o">/</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">j_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">h_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1_d</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> 
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> 
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">j_d</span> <span class="o">/</span> <span class="n">h_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    
    <span class="n">x_sphere</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_sphere</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">j1</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">j1_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere</span><span class="p">)</span>
    <span class="n">h1_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1_d</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere</span><span class="p">)</span>

    <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">d12</span> <span class="o">=</span> <span class="n">h</span>
    <span class="n">d22</span> <span class="o">=</span> <span class="n">x_env</span> <span class="o">*</span> <span class="n">h_d</span>
    <span class="n">d32</span> <span class="o">=</span> <span class="n">x_env</span> <span class="o">*</span> <span class="n">h_d</span> <span class="o">-</span> <span class="n">h</span>
    <span class="n">d14</span> <span class="o">=</span> <span class="n">j1</span>
    <span class="n">f14</span> <span class="o">=</span> <span class="n">h1</span>
    <span class="n">d24</span> <span class="o">=</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">j1_d</span>
    <span class="n">f24</span> <span class="o">=</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">h1_d</span>
    <span class="n">d1L</span> <span class="o">=</span> <span class="n">j</span>
    <span class="n">d2L</span> <span class="o">=</span> <span class="n">x_env</span> <span class="o">*</span> <span class="n">j_d</span>
    <span class="n">d3L</span> <span class="o">=</span> <span class="n">x_env</span> <span class="o">*</span> <span class="n">j_d</span> <span class="o">-</span> <span class="n">j</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_env_t</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">d42</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_env_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_env</span> <span class="o">*</span> <span class="n">h_d</span>
        <span class="n">d4L</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_env_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_env</span> <span class="o">*</span> <span class="n">j_d</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">jt</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env_t</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">jt_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env_t</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env_t</span><span class="p">)</span>
            <span class="n">ht_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1_d</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_env_t</span><span class="p">)</span>
            <span class="n">d21</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ht</span> 
            <span class="n">d31</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_env_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ht</span> <span class="o">-</span> <span class="n">x_env_t</span> <span class="o">*</span> <span class="n">ht_d</span>
            <span class="n">d41</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span> <span class="o">*</span> <span class="n">ht_d</span> <span class="o">-</span> <span class="n">ht</span><span class="p">)</span>
            <span class="n">d2N</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jt</span>
            <span class="n">d3N</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_env_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jt</span> <span class="o">-</span> <span class="n">x_env_t</span> <span class="o">*</span> <span class="n">jt_d</span>
            <span class="n">d4N</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span> <span class="o">*</span> <span class="n">jt_d</span> <span class="o">-</span> <span class="n">jt</span><span class="p">)</span> 

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_sphere_t</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j1t</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere_t</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">j1t_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere_t</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">h1t</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere_t</span><span class="p">)</span>
            <span class="n">h1t_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">spherical_hankel1_d</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x_sphere_t</span><span class="p">)</span>
            <span class="n">f23</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h1t</span>
            <span class="n">d23</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j1t</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_env</span> <span class="o">*</span> <span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d12</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d14</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f14</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta</span>
        <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d1L</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
        <span class="n">rhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">d44</span> <span class="o">=</span> <span class="o">-</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_env_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j1</span> 
        <span class="n">f44</span> <span class="o">=</span> <span class="o">-</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_env_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h1</span> 
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d42</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d44</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d4L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d21</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d3L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d4L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d31</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d32</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d41</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d42</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d44</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">sol_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs_L</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d2N</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d3N</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d4N</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">sol_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs_N</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">res</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">d42</span> <span class="o">=</span> <span class="o">-</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span>
        <span class="n">d44</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">j1_d</span>
        <span class="n">f44</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">h1_d</span>
        <span class="n">d4L</span> <span class="o">=</span> <span class="o">-</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d42</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d44</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d4L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d33</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1t</span> <span class="o">-</span> <span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">j1t_d</span>
            <span class="n">d43</span> <span class="o">=</span> <span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">j1t_d</span> <span class="o">-</span> <span class="n">j1t</span><span class="p">)</span>
            <span class="n">f33</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h1t</span> <span class="o">-</span> <span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">h1t_d</span>
            <span class="n">f43</span> <span class="o">=</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">h1t_d</span> <span class="o">-</span> <span class="n">h1t</span><span class="p">)</span>  
            <span class="n">d34</span> <span class="o">=</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">j1_d</span> <span class="o">-</span> <span class="n">j1</span>    
            <span class="n">f34</span> <span class="o">=</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">h1_d</span> <span class="o">-</span> <span class="n">h1</span> 
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d42</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d23</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">f23</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d33</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">f33</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d43</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">f43</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f23</span> <span class="o">/</span> <span class="n">x_sphere_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d34</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f34</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f33</span> <span class="o">/</span> <span class="n">x_sphere_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d44</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f43</span> <span class="o">/</span> <span class="n">x_sphere_t</span> 
            <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d4L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">res</span> 
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">d44</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
               <span class="o">*</span> <span class="p">((</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">j1_d</span><span class="p">))</span>
        <span class="n">f44</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
               <span class="o">*</span> <span class="p">((</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_sphere</span> <span class="o">*</span> <span class="n">h1_d</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d42</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d44</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d4L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">sol_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs_L</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d11</span> <span class="o">=</span> <span class="n">x_env_t</span> <span class="o">*</span> <span class="n">ht_d</span> <span class="o">+</span> <span class="n">ht</span>
            <span class="n">d13</span> <span class="o">=</span> <span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">j1t_d</span> <span class="o">+</span> <span class="n">j1t</span>
            <span class="n">d33</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
                <span class="o">*</span> <span class="p">((</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1t</span> <span class="o">-</span> <span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">j1t_d</span><span class="p">))</span>
            <span class="n">d43</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="o">*</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> 
                <span class="o">*</span> <span class="p">(</span><span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">j1t_d</span> <span class="o">-</span> <span class="n">j1t</span><span class="p">))</span>
            <span class="n">d34</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
                <span class="o">*</span> <span class="p">(</span><span class="n">x_sphere</span> <span class="o">*</span> <span class="n">j1_d</span> <span class="o">-</span> <span class="n">j1</span><span class="p">))</span>
            <span class="n">f34</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
               <span class="o">*</span> <span class="p">(</span><span class="n">x_sphere</span> <span class="o">*</span> <span class="n">h1_d</span> <span class="o">-</span> <span class="n">h1</span><span class="p">))</span>
            <span class="n">f13</span> <span class="o">=</span> <span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">h1_d</span> <span class="o">+</span> <span class="n">h1</span>
            <span class="n">f33</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
               <span class="o">*</span> <span class="p">((</span><span class="n">psi</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_sphere_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h1t</span> <span class="o">-</span> <span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">h1t_d</span><span class="p">))</span>
            <span class="n">f43</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat_sphere</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_env_t</span><span class="o">/</span><span class="n">x_sphere_t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="o">*</span> <span class="n">psi</span><span class="o">**</span><span class="mi">2</span> 
               <span class="o">*</span> <span class="p">(</span><span class="n">x_sphere_t</span> <span class="o">*</span> <span class="n">h1t_d</span> <span class="o">-</span> <span class="n">h1t</span><span class="p">))</span>
            <span class="n">d1N</span> <span class="o">=</span> <span class="n">x_env_t</span> <span class="o">*</span> <span class="n">jt_d</span> <span class="o">+</span> <span class="n">jt</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d11</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d21</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d31</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d41</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d12</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d22</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d32</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">psi</span> <span class="o">*</span> <span class="n">d42</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d13</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">f13</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f14</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d23</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">f23</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d33</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">f33</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f34</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d43</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">f43</span> <span class="o">/</span> <span class="n">x_sphere_t</span> <span class="o">+</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">tm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span> <span class="o">/</span> <span class="n">x_sphere</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d14</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f14</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f13</span> <span class="o">/</span> <span class="n">x_sphere_t</span> 
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d24</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f24</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f23</span> <span class="o">/</span> <span class="n">x_sphere_t</span> 
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d34</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f34</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f33</span> <span class="o">/</span> <span class="n">x_sphere_t</span> 
            <span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d44</span> <span class="o">+</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f44</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_sphere</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f43</span> <span class="o">/</span> <span class="n">x_sphere_t</span> 
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d1L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d2L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d3L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_L</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">d4L</span> <span class="o">/</span> <span class="n">x_env</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d1N</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d2N</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d3N</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">rhs_N</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">d4N</span> <span class="o">/</span> <span class="n">x_env_t</span>
            <span class="n">sol_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs_N</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">sol_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs_L</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">return</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">res</span> 

<div class="viewcode-block" id="mie_acoustics">
<a class="viewcode-back" href="../../generated/acoustotreams.coeffs.mie_acoustics.html#acoustotreams.coeffs.mie_acoustics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mie_acoustics</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">materials</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Mie scattering coefficient of degree l.</span>

<span class="sd">    The sphere is defined by its size parameter :math:`k_0 r`, where :math:`r` is the</span>
<span class="sd">    radius and :math:`k_0` the wave number in air. A multilayered sphere is defined</span>
<span class="sd">    by giving an array of ascending numbers, that define the size parameters of the</span>
<span class="sd">    sphere and its shells starting from the center.</span>

<span class="sd">    Likewise, the material parameters are given from inside to outside. These arrays</span>
<span class="sd">    are expected to be exactly one unit larger then the array `x`.</span>

<span class="sd">    The result is a complex number relating incident with the scattered modes, which are </span>
<span class="sd">    index in the same way.</span>

<span class="sd">    Note:</span>
<span class="sd">        1. :math:`c_t` of the last material must be zero. </span>
<span class="sd">        2. For the soft and hard spheres, only one radius must be given. </span>

<span class="sd">    Args:</span>
<span class="sd">        l (integer): Degree :math:`l \geq 0`</span>
<span class="sd">        x (float, array_like): Size parameters</span>
<span class="sd">        rho (float or complex, array_like): Mass density</span>
<span class="sd">        c (float or complex, array_like): Longitudinal speed of sound</span>
<span class="sd">        c_t (float or complex, array_like): Transverse speed of sound</span>

<span class="sd">    Returns:</span>
<span class="sd">        complex array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">mat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">materials</span><span class="p">))</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">mie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mat_sphere</span><span class="p">,</span> <span class="n">mat_env</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">mie</span> <span class="o">=</span> <span class="n">_mie_acoustics_iter</span><span class="p">(</span><span class="n">mie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mat_sphere</span><span class="p">,</span> <span class="n">mat_env</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="mie_acoustics_cyl">
<a class="viewcode-back" href="../../generated/acoustotreams.coeffs.mie_acoustics_cyl.html#acoustotreams.coeffs.mie_acoustics_cyl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mie_acoustics_cyl</span><span class="p">(</span><span class="n">kz</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="o">*</span><span class="n">materials</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Scattering coefficient at an infinite cylinder</span>

<span class="sd">    The cylinder is defined by its radii.</span>
<span class="sd">    Likewise, the material parameters are given from inside to outside. These arrays</span>
<span class="sd">    are expected to be exactly one unit larger then the array `radii`.</span>

<span class="sd">    The result is a complex number relating incident with the scattered modes, </span>
<span class="sd">    which are index in the same way.</span>

<span class="sd">    Args:</span>
<span class="sd">        kz (float): Z component of the wave</span>
<span class="sd">        m (integer): Order</span>
<span class="sd">        k0 (float or complex): Wave number in vacuum</span>
<span class="sd">        radii (float, array_like): Size parameters</span>
<span class="sd">        rho (float or complex, array_like): Mass density</span>
<span class="sd">        c (float or complex, array_like): Longitudinal speed of sound</span>
<span class="sd">        c_t (float or complex, array_like): Transverse speed of sound</span>

<span class="sd">    Returns:</span>
<span class="sd">        complex</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mat_cyl</span><span class="p">,</span> <span class="n">mat_env</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">materials</span><span class="p">)</span> 
    <span class="n">k_env</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
    <span class="n">krho_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k_env</span> <span class="o">*</span> <span class="n">k_env</span> <span class="o">-</span> <span class="n">kz</span> <span class="o">*</span> <span class="n">kz</span><span class="p">)</span>
    <span class="n">x_env</span> <span class="o">=</span> <span class="n">krho_env</span> <span class="o">*</span> <span class="n">radii</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_env</span><span class="p">)</span>
    <span class="n">j_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv_d</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_env</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">hankel1</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_env</span><span class="p">)</span>
    <span class="n">h_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">hankel1_d</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_env</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">j_d</span> <span class="o">/</span> <span class="n">h_d</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">j</span> <span class="o">/</span> <span class="n">h</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">k_cyl</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
        <span class="n">krho_cyl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k_cyl</span> <span class="o">*</span> <span class="n">k_cyl</span> <span class="o">-</span> <span class="n">kz</span> <span class="o">*</span> <span class="n">kz</span><span class="p">)</span>
        <span class="n">x_cyl</span> <span class="o">=</span> <span class="n">krho_cyl</span> <span class="o">*</span> <span class="n">radii</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_cyl</span><span class="p">)</span>
        <span class="n">j1_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv_d</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_cyl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">x_cyl</span> <span class="o">*</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_env</span> <span class="o">*</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">j1_d</span> <span class="o">*</span> <span class="n">j</span> <span class="o">-</span> <span class="n">j1</span> <span class="o">*</span> <span class="n">j_d</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">j1</span> <span class="o">*</span> <span class="n">h_d</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">j1_d</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mat_cyl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k_cyl_t</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
            <span class="n">krho_cyl_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k_cyl_t</span> <span class="o">*</span> <span class="n">k_cyl_t</span> <span class="o">-</span> <span class="n">kz</span> <span class="o">*</span> <span class="n">kz</span><span class="p">)</span> 
            <span class="n">x_cyl_t</span> <span class="o">=</span> <span class="n">krho_cyl_t</span> <span class="o">*</span> <span class="n">radii</span>
            <span class="n">j1t</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_cyl_t</span><span class="p">)</span>
            <span class="n">j1t_d</span> <span class="o">=</span> <span class="n">treams</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv_d</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x_cyl_t</span><span class="p">)</span>
            <span class="n">j1t_dd</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">j1t_d</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_cyl_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1t</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_cyl_t</span>
            <span class="n">j1_dd</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">j1_d</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_cyl</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_cyl</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
            <span class="n">lam_0</span> <span class="o">=</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mat_env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">mu_1</span> <span class="o">=</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">lam_1</span> <span class="o">=</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mat_cyl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu_1</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">kz</span> <span class="o">*</span> <span class="n">krho_cyl</span><span class="o">/</span><span class="n">k_cyl</span> <span class="o">*</span> <span class="n">j1_d</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">krho_cyl_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">kz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">k_cyl_t</span> <span class="o">*</span> <span class="n">j1t_d</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_env</span> <span class="o">*</span> <span class="n">lam_0</span> <span class="o">*</span> <span class="n">h</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu_1</span> <span class="o">*</span> <span class="n">krho_cyl</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">k_cyl</span> <span class="o">*</span> <span class="n">j1_dd</span> <span class="o">-</span> <span class="n">k_cyl</span> <span class="o">*</span> <span class="n">lam_1</span> <span class="o">*</span> <span class="n">j1</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">mu_1</span> <span class="o">*</span> <span class="n">kz</span> <span class="o">*</span> <span class="n">krho_cyl_t</span><span class="o">/</span><span class="n">k_cyl_t</span> <span class="o">*</span> <span class="n">j1t_dd</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_env</span> <span class="o">*</span> <span class="n">lam_0</span> <span class="o">*</span> <span class="n">j</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">krho_env</span><span class="o">/</span><span class="n">k_env</span> <span class="o">*</span> <span class="n">h_d</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">krho_cyl</span><span class="o">/</span><span class="n">k_cyl</span> <span class="o">*</span> <span class="n">j1_d</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">kz</span><span class="o">/</span><span class="n">k_cyl_t</span> <span class="o">*</span> <span class="n">j1t_d</span>
            <span class="n">rhs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">krho_env</span><span class="o">/</span><span class="n">k_env</span> <span class="o">*</span> <span class="n">j_d</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="fresnel_acoustics">
<a class="viewcode-back" href="../../generated/acoustotreams.coeffs.fresnel_acoustics.html#acoustotreams.coeffs.fresnel_acoustics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fresnel_acoustics</span><span class="p">(</span><span class="n">kzs</span><span class="p">,</span> <span class="n">rhos</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Fresnel coefficients for a planar interface.</span>

<span class="sd">    The first two dimensions index the two media for the above</span>
<span class="sd">    and below the S-matrix, the second two dimensions are added </span>
<span class="sd">    to meet the treams convention.</span>

<span class="sd">    The result is an array relating incoming with the outgoing modes, which </span>
<span class="sd">    are indexed in the same way. The first dimension of the array are the outgoing </span>
<span class="sd">    and the second dimension the incoming modes</span>

<span class="sd">    Args:</span>
<span class="sd">        kzs (float): Z component of the waves</span>
<span class="sd">        rhos (float or complex): Mass densities</span>

<span class="sd">    Returns:</span>
<span class="sd">        complex (2, 2, 1, 1)-array</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rhos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">rhos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rhos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">rhos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">rhos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rhos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">kzs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span></div>



<span class="c1">#if (np.abs(mat_sphere[2]) == 0 </span>
<span class="c1">#    and np.abs(mat_sphere[1]) == 0 </span>
<span class="c1">#    and np.abs(mat_sphere[0]) == 0</span>
<span class="c1">#    and np.abs(mat_env[2]) &gt; 0):</span>
<span class="c1">#    if l == 0:</span>
<span class="c1">#        return np.array([-j / h, 0, 0, 0])</span>
<span class="c1">#    matrix = np.zeros((2, 2), complex)</span>
<span class="c1">#    rhs_L = np.zeros(2, complex)</span>
<span class="c1">#    rhs_N = np.zeros(2, complex)</span>
<span class="c1">#    matrix[0][0] = d31 / x_env_t</span>
<span class="c1">#    matrix[0][1] = -psi * d32 / x_env</span>
<span class="c1">#    matrix[1][0] = d41 / x_env_t</span>
<span class="c1">#    matrix[1][1] = -psi * d42 / x_env</span>
<span class="c1">#    rhs_L[0] = psi * d3L / x_env</span>
<span class="c1">#    rhs_L[1] = psi * d4L / x_env</span>
<span class="c1">#    rhs_N[0] = -d3N / x_env_t</span>
<span class="c1">#    rhs_N[1] = -d4N / x_env_t</span>
<span class="c1">#    sol_L = np.linalg.solve(matrix, rhs_L)</span>
<span class="c1">#    res[0] = sol_L[1]</span>
<span class="c1">#    res[1] = sol_L[0]</span>
<span class="c1">#    sol_N = np.linalg.solve(matrix, rhs_N)</span>
<span class="c1">#    res[2] = sol_N[1]</span>
<span class="c1">#    res[3] = sol_N[0]</span>
<span class="c1">#    return res</span>

<span class="c1">#if (np.abs(mat_sphere[2]) == 0 </span>
<span class="c1">#    and np.abs(mat_sphere[1]) == 0 </span>
<span class="c1">#    and np.abs(mat_sphere[0]) == np.inf</span>
<span class="c1">#    and np.abs(mat_env[2]) &gt; 0):</span>
<span class="c1">#    if l == 0:</span>
<span class="c1">#        return np.array([-j_d / h_d, 0, 0, 0])</span>
<span class="c1">#    matrix = np.zeros((2, 2), complex)</span>
<span class="c1">#    rhs_L = np.zeros(2, complex)</span>
<span class="c1">#    rhs_N = np.zeros(2, complex)</span>
<span class="c1">#    matrix[0][0] = d11 / x_env_t</span>
<span class="c1">#    matrix[0][1] = -psi * d12 / x_env</span>
<span class="c1">#    matrix[1][0] = d21 / x_env_t</span>
<span class="c1">#    matrix[1][1] = -psi * d22 / x_env</span>
<span class="c1">#    rhs_L[0] = psi * d1L / x_env</span>
<span class="c1">#    rhs_L[1] = psi * d2L / x_env</span>
<span class="c1">#    rhs_N[0] = -d1N / x_env_t</span>
<span class="c1">#    rhs_N[1] = -d2N / x_env_t</span>
<span class="c1">#    sol_L = np.linalg.solve(matrix, rhs_L)</span>
<span class="c1">#    res[0] = sol_L[1]</span>
<span class="c1">#    res[1] = sol_L[0]</span>
<span class="c1">#    sol_N = np.linalg.solve(matrix, rhs_N)</span>
<span class="c1">#    res[2] = sol_N[1]</span>
<span class="c1">#    res[3] = sol_N[0]</span>
<span class="c1">#    return res</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acoustotreams.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev.html">Development and contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">acoustotreams 0.2.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acoustotreams.coeffs</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Nikita Ustimenko.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>