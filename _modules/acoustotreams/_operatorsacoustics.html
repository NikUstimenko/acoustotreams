<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>acoustotreams._operatorsacoustics &#8212; acoustotreams 0.1.47 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=0c472235" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css?v=424f8d56" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4ec84db" />
    <script src="../../_static/documentation_options.js?v=5df2d9e8"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">acoustotreams 0.1.47 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acoustotreams._operatorsacoustics</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for acoustotreams._operatorsacoustics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Operators for common transformations including different types of waves.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">treams.special</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">treams</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">treams._lattice</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">WaveVector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._materialacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcousticMaterial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams._coreacoustics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">core</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">treams._operators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Operator</span><span class="p">,</span><span class="n">FieldOperator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams._wavesacoustics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">wv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams.ssw</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ssw</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams.spw</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">spw</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams.scw</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">scw</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ssw</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span> <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scw</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">zm</span><span class="p">),</span> <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">zm</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spwa_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate scalar plane waves (actually rotates the basis).&quot;&quot;&quot;</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c1</span><span class="p">,</span> <span class="o">-</span><span class="n">s1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">r</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basis</span><span class="o">.</span><span class="n">qx</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">qy</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">qz</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">newbasis</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByUnitVector</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">kvecs</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newbasis</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">kpar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newbasis</span><span class="o">.</span><span class="n">kpar</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kpar</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">newbasis</span><span class="p">,</span> <span class="n">basis</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spwp_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate partial scalar plane waves (actually rotates the basis).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">alignment</span> <span class="o">!=</span> <span class="s2">&quot;xy&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rotation on alignment: &#39;</span><span class="si">{</span><span class="n">basis</span><span class="o">.</span><span class="n">alignment</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c1</span><span class="p">,</span> <span class="o">-</span><span class="n">s1</span><span class="p">],</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]])</span>
    <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[()]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">newbasis</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">r</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">]))))</span>
    <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newbasis</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">kpar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newbasis</span><span class="o">.</span><span class="n">kpar</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kpar</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">newbasis</span><span class="p">,</span> <span class="n">basis</span><span class="p">))</span>


<div class="viewcode-block" id="rotate">
<a class="viewcode-back" href="../../generated/acoustotreams.rotate.html#acoustotreams.rotate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotation matrix.</span>

<span class="sd">    For the given Euler angles apply a rotation for the given basis. In some basis sets</span>
<span class="sd">    only rotations around the z-axis are permitted.</span>

<span class="sd">    Args:</span>
<span class="sd">        phi (float): First Euler angle (rotation about z)</span>
<span class="sd">        theta (float, optional): Second Euler angle (rotation about y)</span>
<span class="sd">        psi (float, optional): Third Euler angle (rotation about z)</span>
<span class="sd">        basis (:class:`ScalarBasisSet` or tuple): Basis set, if it is a tuple of two</span>
<span class="sd">            basis sets the output and input modes are taken accordingly, else both sets</span>
<span class="sd">            of modes are the same.</span>
<span class="sd">        where (array-like, bool, optional): Only evaluate parts of the rotation matrix,</span>
<span class="sd">            the given array must have a shape that matches the output shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_basis</span> <span class="o">=</span> <span class="n">basis</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ssw_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">theta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;non-zero theta for rotation&quot;</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_scw_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_basis</span> <span class="o">!=</span> <span class="n">basis</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_spwp_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByUnitVector</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_spwa_rotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">Rotate</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">rotate</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="n">isinv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;basis&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FUNC</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    

<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_translate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">)</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2sph</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ssw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span>
        <span class="n">ks</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">singular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">k0</span><span class="p">),</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">material</span><span class="p">),</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_translate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">)</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
    <span class="n">krhos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ks</span> <span class="o">*</span> <span class="n">ks</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span> <span class="o">*</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span><span class="p">)</span>
    <span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2cyl</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">zm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">zm</span><span class="p">,</span>
        <span class="n">krhos</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">singular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">k0</span><span class="p">),</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="n">material</span><span class="o">=</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">material</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_spw_translate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate scalar plane waves.&quot;&quot;&quot;</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">kz</span> <span class="o">=</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">where</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">where</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">kvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ky</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">kvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kz</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">kvecs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="n">kvecs</span><span class="p">,</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="p">(</span><span class="n">k0</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="p">(</span><span class="n">material</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="n">modetype</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="translate">
<a class="viewcode-back" href="../../generated/acoustotreams.translate.html#acoustotreams.translate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">translate</span><span class="p">(</span>
    <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translation matrix.</span>

<span class="sd">    Translate the given basis modes along the translation vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (array-like): Translation vector</span>
<span class="sd">        basis (:class:`ScalarBasisSet` or tuple): Basis set, if it is a tuple of two</span>
<span class="sd">            basis sets the output and input modes are taken accordingly, else both sets</span>
<span class="sd">            of modes are the same.</span>
<span class="sd">        k0 (float, optional): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode, only used for</span>
<span class="sd">            :class:`ScalarPlaneWaveBasisByComp`.</span>
<span class="sd">        where (array-like, bool, optional): Only evaluate parts of the translation</span>
<span class="sd">            matrix, the given array must have a shape that matches the output shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid &#39;r&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
            <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_spw_translate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ssw_translate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_scw_translate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">Translate</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translation matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable translation matrix to</span>
<span class="sd">    transform it. See also :func:`translate`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="n">isinv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;basis&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FUNC</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_ssw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">to_modetype</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar spherical waves into scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span> <span class="o">==</span> <span class="n">to_modetype</span>
        <span class="ow">or</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span> <span class="o">==</span> <span class="n">to_modetype</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span> <span class="ow">and</span> <span class="n">to_modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid expansion from </span><span class="si">{</span><span class="n">modetype</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">to_modetype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2sph</span><span class="p">(</span><span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ssw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span>
        <span class="n">ks</span> <span class="o">*</span> <span class="n">rs</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">singular</span><span class="o">=</span><span class="n">modetype</span> <span class="o">!=</span> <span class="n">to_modetype</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span> <span class="ow">and</span> <span class="n">to_modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">modetype</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_modetype</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_scw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar cylindrical waves into scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">)</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scw</span><span class="o">.</span><span class="n">to_ssw</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">zm</span><span class="p">,</span>
        <span class="n">ks</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">),</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_spw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar plane waves into scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">to_ssw</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">kvecs</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">*</span> <span class="n">spw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="n">kvecs</span><span class="p">,</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="n">modetype</span><span class="p">),</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_scw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">to_modetype</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar cylindrical waves into scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2cyl</span><span class="p">(</span><span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">krhos</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">krhos</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">zm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">zm</span><span class="p">,</span>
        <span class="n">krhos</span> <span class="o">*</span> <span class="n">rs</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">singular</span><span class="o">=</span><span class="n">modetype</span> <span class="o">!=</span> <span class="n">to_modetype</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span> <span class="ow">and</span> <span class="n">to_modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">modetype</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_modetype</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_spw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar plane waves into scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">to_scw</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">zm</span><span class="p">),</span> <span class="o">*</span><span class="n">kvecs</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span>
    <span class="p">)</span> <span class="o">*</span> <span class="n">spw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="n">kvecs</span><span class="p">,</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="n">modetype</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spw_spw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar plane waves into scalar plane waves.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
    <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">kz</span> <span class="o">=</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">where</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">kx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">kvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">ky</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">kvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">kz</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">kvecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span>
    <span class="p">)</span>


<div class="viewcode-block" id="expand">
<a class="viewcode-back" href="../../generated/acoustotreams.expand.html#acoustotreams.expand">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">expand</span><span class="p">(</span>
    <span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span> <span class="n">where</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expansion matrix.</span>

<span class="sd">    Expand the modes from one basis set to another basis set. If applicable the modetype</span>
<span class="sd">    can also be changed, like for spherical and cylindrical waves from `singular` to</span>
<span class="sd">    `regular`. Not all expansions are available, only those that result in a discrete</span>
<span class="sd">    set of modes. For example, plane waves can be expanded in spherical waves, but the</span>
<span class="sd">    opposite transformation generally requires a continuous spectrum (an integral) over</span>
<span class="sd">    plane waves.</span>

<span class="sd">    Args:</span>
<span class="sd">        basis (:class:`ScalarBasisSet` or tuple): Basis set, if it is a tuple of two</span>
<span class="sd">            basis sets the output and input modes are taken accordingly, else both sets</span>
<span class="sd">            of modes are the same.</span>
<span class="sd">        modetype (str, optional): Wave mode, used for</span>
<span class="sd">            :class:`ScalarSphericalWaveBasis` (and :class:`ScalarCylindricalWaveBasis`).</span>
<span class="sd">        k0 (float, optional): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        where (array-like, bool, optional): Only evaluate parts of the expansion matrix,</span>
<span class="sd">            the given array must have a shape that matches the output shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modetype</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">to_modetype</span><span class="p">,</span> <span class="n">modetype</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_modetype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span>
    <span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="n">to_modetype</span> <span class="o">=</span> <span class="n">modetype</span> <span class="k">if</span> <span class="n">to_modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">to_modetype</span>
        <span class="k">return</span> <span class="n">_ssw_ssw_expand</span><span class="p">(</span>
            <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">to_modetype</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
            <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
            <span class="n">to_modetype</span> <span class="o">=</span> <span class="n">modetype</span> <span class="k">if</span> <span class="n">to_modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">to_modetype</span>
            <span class="k">return</span> <span class="n">_scw_scw_expand</span><span class="p">(</span>
                <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">to_modetype</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">modetype</span> <span class="o">!=</span> <span class="s2">&quot;regular&quot;</span> <span class="ow">and</span> <span class="n">to_modetype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid expansion from </span><span class="si">{</span><span class="n">modetype</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">to_modetype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_ssw_scw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
            <span class="n">to_modetype</span> <span class="o">=</span> <span class="n">modetype</span> <span class="k">if</span> <span class="n">to_modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">to_modetype</span>
            <span class="k">return</span> <span class="n">_spw_spw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">to_modetype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_scw_spw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">to_modetype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_ssw_spw_expand</span><span class="p">(</span>
                <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span>
            <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">Expand</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expansion matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable transformation matrix to</span>
<span class="sd">    expand one set of modes into another basis set (and mode type, if applicable).</span>
<span class="sd">    See also :func:`expand`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">expand</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">basis</span><span class="p">,)</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="n">isinv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isinv</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_inv</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;basis&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;modetype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;modetype&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FUNC</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;basis&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">),</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;modetype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;modetype&quot;</span><span class="p">),</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FUNC</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="s2">&quot;modetype&quot;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse expansion.</span>

<span class="sd">        The inverse transformation is not available for all transformations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">basis</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modetype</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">modetype</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">modetype</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isinv</span><span class="p">)</span>
    

<span class="k">def</span><span class="w"> </span><span class="nf">_sswl_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar spherical waves in a lattice.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="k">if</span> <span class="n">lattice</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Last attempt to determine the dimension of the sum</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kpar</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kpar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span>
    <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lattice</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kpar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">lattice</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kpar</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kpar</span><span class="p">[:]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ssw</span><span class="o">.</span><span class="n">translate_periodic</span><span class="p">(</span>
        <span class="n">ks</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">lattice</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
        <span class="n">to_basis</span><span class="p">[()],</span>
        <span class="n">basis</span><span class="p">[()],</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
        <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">),</span>
        <span class="n">kpar</span><span class="o">=</span><span class="n">kpar</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_scw_ssw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar spherical waves into scalar cylindrical waves in a lattice.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">)</span>
    <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ssw</span><span class="o">.</span><span class="n">periodic_to_scw</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">zm</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span>
        <span class="n">ks</span><span class="p">,</span>
        <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="s2">&quot;singular&quot;</span><span class="p">,</span>
        <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span>
        <span class="n">kpar</span><span class="o">=</span><span class="n">kpar</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spw_ssw_expand</span><span class="p">(</span>
    <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar spherical waves into scalar plane waves in a lattice.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span>
    <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">transl</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">kvecs</span><span class="p">),</span>
        <span class="o">-</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="o">-</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="o">-</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">transl</span><span class="p">[:,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">]</span> <span class="o">*</span> <span class="n">ssw</span><span class="o">.</span><span class="n">periodic_to_spw</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">kvecs</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">lm</span><span class="p">,</span>
        <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">kpar</span><span class="o">=</span><span class="n">kpar</span><span class="p">,</span>
        <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="n">modetype</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_scwl_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar cylindrical waves in a lattice.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
    <span class="n">alignment</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;x&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">alignment</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lattice</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Last attempt to determine the dimension of the sum</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lattice</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">lattice</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kpar</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scw</span><span class="o">.</span><span class="n">translate_periodic</span><span class="p">(</span>
        <span class="n">ks</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">lattice</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
        <span class="n">to_basis</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
        <span class="n">to_basis</span><span class="p">[()],</span>
        <span class="n">basis</span><span class="p">[()],</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
        <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">kpar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kpar</span> <span class="o">=</span> <span class="n">kpar</span> <span class="o">&amp;</span> <span class="n">b</span><span class="o">.</span><span class="n">kpar</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">),</span>
        <span class="n">kpar</span><span class="o">=</span><span class="n">kpar</span><span class="p">,</span>
    <span class="p">)</span>



<span class="k">def</span><span class="w"> </span><span class="nf">_spw_scw_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand scalar cylindrical waves into scalar plane waves in a lattice.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kpar</span> <span class="o">=</span> <span class="n">WaveVector</span><span class="p">(</span><span class="n">kpar</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">transl</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">kvecs</span><span class="p">),</span>
        <span class="o">-</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="o">-</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="o">-</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">transl</span><span class="p">[:,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">]</span> <span class="o">*</span> <span class="n">scw</span><span class="o">.</span><span class="n">periodic_to_spw</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">kvecs</span><span class="p">),</span>
        <span class="o">*</span><span class="n">basis</span><span class="o">.</span><span class="n">zm</span><span class="p">,</span>
        <span class="n">lattice</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">modetype</span><span class="o">=</span><span class="p">(</span><span class="n">modetype</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">),</span>
        <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span>
        <span class="n">kpar</span><span class="o">=</span><span class="n">kpar</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="expandlattice">
<a class="viewcode-back" href="../../generated/acoustotreams.expandlattice.html#acoustotreams.expandlattice">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">expandlattice</span><span class="p">(</span>
    <span class="n">lattice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kpar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">eta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span>
    <span class="n">where</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expansion matrix in lattices.</span>

<span class="sd">    Expand the modes from one basis set which are assumed to be periodically repeated on</span>
<span class="sd">    a lattice into another basis set.</span>

<span class="sd">    Args:</span>
<span class="sd">        lattice (:class:`~treams.Lattice` or array-like, optional): Lattice definition.</span>
<span class="sd">            In some cases this argument can be omitted, when the lattice can be inferred</span>
<span class="sd">            from the basis.</span>
<span class="sd">        kpar (sequence, optional): The components of the wave vector tangential to the</span>
<span class="sd">            lattice. In some cases this argument can be omitted, when the lattice can be</span>
<span class="sd">            inferred from the basis.</span>
<span class="sd">        basis (:class:`~acoustotreams.ScalarBasisSet` or tuple): Basis set, if it is a tuple of two</span>
<span class="sd">            basis sets the output and input modes are taken accordingly, else both sets</span>
<span class="sd">            of modes are the same.</span>
<span class="sd">        k0 (float, optional): Wave number.</span>
<span class="sd">        eta (float or complex, optional): Split parameter used when the Ewald summation</span>
<span class="sd">            is applied for the lattice sums. By setting it to 0 the split is set</span>
<span class="sd">            automatically.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode, used for</span>
<span class="sd">            :class:`ScalarPlaneWaveBasisByComp`.</span>
<span class="sd">        where (array-like, bool, optional): Only evaluate parts of the expansion matrix,</span>
<span class="sd">            the give array must have a shape that matches the output shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">to_basis</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_basis</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">if</span> <span class="n">lattice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lattice</span> <span class="o">=</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">lattice</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">Lattice</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;z&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span>
    <span class="p">):</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">alignment</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kpar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">basis</span><span class="o">.</span><span class="n">kpar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kpar</span> <span class="o">=</span> <span class="n">to_basis</span><span class="o">.</span><span class="n">kpar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpar</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kpar</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">kpar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kpar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kpar</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpar</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpar</span><span class="p">]</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_sswl_expand</span><span class="p">(</span>
                <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_scw_ssw_expand</span><span class="p">(</span>
                <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modetype</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">modetype</span> <span class="o">=</span> <span class="n">modetype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">_spw_ssw_expand</span><span class="p">(</span>
                <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_scwl_expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modetype</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">modetype</span> <span class="o">=</span> <span class="n">modetype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">_spw_scw_expand</span><span class="p">(</span>
                <span class="n">basis</span><span class="p">,</span> <span class="n">to_basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">where</span>
            <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">ExpandLattice</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expansion matrix in a lattice.</span>

<span class="sd">    When called as attribute of an object it returns a suitable transformation matrix to</span>
<span class="sd">    expand one set of modes that is periodically repeated into another basis set.</span>
<span class="sd">    See also :func:`expandlattice`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">expandlattice</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kpar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">modetype</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isinv</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_inv</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;basis&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;modetype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;modetype&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s2">&quot;lattice&quot;</span><span class="p">,</span> <span class="s2">&quot;kpar&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FUNC</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;modetype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="s2">&quot;lattice&quot;</span><span class="p">,</span> <span class="s2">&quot;kpar&quot;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse expansion for periodic arrangements.</span>

<span class="sd">        The inverse transformation is not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spwp_permute</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permute axes in a scalar partial plane wave basis.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;missing definition of &#39;material&#39;&quot;</span><span class="p">)</span>
    <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">))</span>
    <span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvecs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">kvecs</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">permute_xyz</span><span class="p">(</span>
            <span class="n">kvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">kvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">kvecs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">permute_xyz</span><span class="p">(</span>
            <span class="n">kvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">kvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">kvecs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
    <span class="n">res</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">basis</span><span class="p">))</span>    


<span class="k">def</span><span class="w"> </span><span class="nf">_spwa_permute</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permute axes in a scalar plane wave basis.&quot;&quot;&quot;</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">qx</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">qy</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">qz</span>
    <span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">qx</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">qx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">qy</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">qy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">qz</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">qz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">permute_xyz</span><span class="p">(</span>
            <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">permute_xyz</span><span class="p">(</span>
            <span class="n">qx</span><span class="p">,</span>
            <span class="n">qy</span><span class="p">,</span>
            <span class="n">qz</span><span class="p">,</span>
            <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">))</span>
    <span class="n">res</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">where</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">AcousticsArray</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">basis</span><span class="p">))</span>


<div class="viewcode-block" id="permute">
<a class="viewcode-back" href="../../generated/acoustotreams.permute.html#acoustotreams.permute">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">permute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permutation matrix.</span>

<span class="sd">    Permute the axes of a scalar plane wave basis expansion.</span>

<span class="sd">    Args:</span>
<span class="sd">        n (int, optional): Number of permutations, defaults to 1.</span>
<span class="sd">        basis (:class:`~acoustotreams.ScalarBasisSet` or tuple): Basis set, if it is a tuple of two</span>
<span class="sd">            basis sets the output and input modes are taken accordingly, else both sets</span>
<span class="sd">            of modes are the same.</span>
<span class="sd">        k0 (float, optional): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;n&#39; must be integer&quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_spwp_permute</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByUnitVector</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_spwa_permute</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">Permute</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Axes permutation matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable transformation matrix to</span>
<span class="sd">    permute the axis definitions of plane waves. See also :func:`permute`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">permute</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="n">isinv</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="n">isinv</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isinv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;basis&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FUNC</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    


<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Velocity field of scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">rsph</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2sph</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vsw_rL</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">ks</span> <span class="o">*</span> <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vsw_L</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">ks</span> <span class="o">*</span> <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="n">res</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">vsph2car</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="p">:]))</span>    
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_scw_vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Velocity field of scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
    <span class="n">krhos</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">krhos</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>
    <span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rcyl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2cyl</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vcw_rL</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">krhos</span> <span class="o">*</span> <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">krhos</span><span class="p">,</span>
            <span class="n">ks</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vcw_L</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">krhos</span> <span class="o">*</span> <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">krhos</span><span class="p">,</span>
            <span class="n">ks</span>
        <span class="p">)</span>   
    <span class="n">res</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">vcyl2car</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="p">:]))</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spw_vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Velocity field of scalar plane waves.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vpw_L</span><span class="p">(</span><span class="o">*</span><span class="n">kvecs</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="vfield">
<a class="viewcode-back" href="../../generated/acoustotreams.vfield.html#acoustotreams.vfield">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Velocity field.</span>

<span class="sd">    The resulting matrix maps the pressure field coefficients of the given basis to the</span>
<span class="sd">    velocity field in Cartesian coordinates.</span>

<span class="sd">    The velocity field is given in units of :math:`\frac{1}{\rho c}p`.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (array-like): Evaluation points</span>
<span class="sd">        basis (:class:`~acoustotreams.ScalarBasisSet`): Basis set.</span>
<span class="sd">        k0 (float): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_ssw_vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_scw_vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
            <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_spw_vfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">VField</span><span class="p">(</span><span class="n">FieldOperator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Velocity field evaluation matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable matrix to evaluate field</span>
<span class="sd">    coefficients at specified points. See also :func:`vfield`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">vfield</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pressure field of scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">rsph</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2sph</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">ssw_rPsi</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">ks</span> <span class="o">*</span> <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">ssw_Psi</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">ks</span> <span class="o">*</span> <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pressure field of scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">krhos</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">krhos</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>
    <span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rcyl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2cyl</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">scw_rPsi</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">krhos</span> <span class="o">*</span> <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">scw_Psi</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">krhos</span> <span class="o">*</span> <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span>   
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_spw_pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pressure field of scalar plane waves.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">kvecs</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">kvecs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">spw_Psi</span><span class="p">(</span><span class="o">*</span><span class="n">kvecs</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="pfield">
<a class="viewcode-back" href="../../generated/acoustotreams.pfield.html#acoustotreams.pfield">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pressure field.</span>

<span class="sd">    The resulting matrix maps the pressure field coefficients of the given basis to the</span>
<span class="sd">    pressure field.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (array-like): Evaluation points</span>
<span class="sd">        basis (:class:`~acoustotreams.ScalarBasisSet`): Basis set.</span>
<span class="sd">        k0 (float): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_ssw_pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_scw_pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasis</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarPlaneWaveBasisByComp</span><span class="p">):</span>
            <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">return</span> <span class="n">_spw_pfield</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">PField</span><span class="p">(</span><span class="n">FieldOperator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pressure field evaluation matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable matrix to evaluate field</span>
<span class="sd">    coefficients at specified points. See also :func:`pfield`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">pfield</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_pamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of pressure field of singular scalar spherical waves.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2sph</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">rsph</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">ssw_psi</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">ks</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_pamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of pressure field of singular scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2cyl</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">krhos</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">krhos</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>
    <span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rcyl</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">scw_psi</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">krhos</span><span class="p">,</span>
        <span class="p">)</span>   
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="pamplitudeff">
<a class="viewcode-back" href="../../generated/acoustotreams.pamplitudeff.html#acoustotreams.pamplitudeff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of pressure field.</span>

<span class="sd">    The resulting matrix maps the scattered pressure field coefficients in the scalar </span>
<span class="sd">    spherical or cylindrical wave basis to the far-field amplitude of the pressure field.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (array-like): Evaluation points</span>
<span class="sd">        basis (:class:`~acoustotreams.ScalarBasisSet`): Basis set.</span>
<span class="sd">        k0 (float): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;singular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_ssw_pamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;singular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_scw_pamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">PAmplitudeFF</span><span class="p">(</span><span class="n">FieldOperator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of pressure field evaluation matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable matrix to evaluate field</span>
<span class="sd">    coefficients at specified points. See also :func:`pamplitudeff`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">pamplitudeff</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ssw_vamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of velocity field of singular vector spherical waves L.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2sph</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">rsph</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vsw_l</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">rsph</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">ks</span>
        <span class="p">)</span>
    <span class="n">res</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>    
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scw_vamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of pressure field of singular scalar cylindrical waves.&quot;&quot;&quot;</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">AcousticMaterial</span><span class="p">()</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">car2cyl</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">krhos</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">krhos</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>
    <span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">krhos</span><span class="p">[</span><span class="n">krhos</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rcyl</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">positions</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wv</span><span class="o">.</span><span class="n">vcw_l</span><span class="p">(</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">rcyl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">pidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">krhos</span><span class="p">,</span>
            <span class="n">ks</span><span class="p">,</span>
        <span class="p">)</span>   
    <span class="n">res</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">material</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid parameters&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">AnnotatedArray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;k0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k0</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
    <span class="n">res</span><span class="o">.</span><span class="n">ann</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;modetype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modetype</span>
    <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="vamplitudeff">
<a class="viewcode-back" href="../../generated/acoustotreams.vamplitudeff.html#acoustotreams.vamplitudeff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">vamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">AcousticMaterial</span><span class="p">(),</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of velocity field.</span>

<span class="sd">    The resulting matrix maps the scattered pressure field coefficients in the scalar </span>
<span class="sd">    spherical or cylindrical wave basis to the far-field amplitude of the velocity field</span>
<span class="sd">    in spherical or cylindrical coordinates, respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (array-like): Evaluation points</span>
<span class="sd">        basis (:class:`~acoustotreams.ScalarBasisSet`): Basis set.</span>
<span class="sd">        k0 (float): Wave number.</span>
<span class="sd">        material (:class:`~acoustotreams.AcousticMaterial` or tuple, optional): Material parameters.</span>
<span class="sd">        modetype (str, optional): Wave mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarSphericalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;singular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_ssw_vamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">ScalarCylindricalWaveBasis</span><span class="p">):</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;singular&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
        <span class="k">if</span> <span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;regular&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_scw_vamplitudeff</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;invalid basis&quot;</span><span class="p">)</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">VAmplitudeFF</span><span class="p">(</span><span class="n">FieldOperator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Far-field amplitude of velocity field evaluation matrix.</span>

<span class="sd">    When called as attribute of an object it returns a suitable matrix to evaluate field</span>
<span class="sd">    coefficients at specified points. See also :func:`vamplitudeff`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FUNC</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">vamplitudeff</span><span class="p">)</span>


</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acoustotreams.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev.html">Development and contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">acoustotreams 0.1.47 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acoustotreams._operatorsacoustics</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Nikita Ustimenko.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>