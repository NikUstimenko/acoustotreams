<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>acoustotreams._tmatrixacoustics &#8212; acoustotreams 0.2.13 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=0c472235" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css?v=424f8d56" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4ec84db" />
    <script src="../../_static/documentation_options.js?v=ba481074"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">acoustotreams 0.2.13 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acoustotreams._tmatrixacoustics</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for acoustotreams._tmatrixacoustics</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">treams.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnnotationError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._coreacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarSphericalWaveBasis</span> <span class="k">as</span> <span class="n">SSWB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._coreacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarPlaneWaveBasisByComp</span> <span class="k">as</span> <span class="n">SPWBC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._coreacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarCylindricalWaveBasis</span> <span class="k">as</span> <span class="n">SCWB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._coreacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarPlaneWaveBasisByUnitVector</span> <span class="k">as</span> <span class="n">SPWBUV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._materialacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcousticMaterial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams.coeffs</span><span class="w"> </span><span class="kn">import</span> <span class="n">mie_acoustics</span><span class="p">,</span> <span class="n">mie_acoustics_cyl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acoustotreams._coreacoustics</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcousticsArray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams._operatorsacoustics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">opa</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">acoustotreams.special</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ats</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_Interaction</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objtype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objtype</span> <span class="o">=</span> <span class="n">objtype</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="o">.</span><span class="n">basis</span>
        <span class="k">return</span> <span class="p">(</span>
             <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">@</span> <span class="n">opa</span><span class="o">.</span><span class="n">Expand</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inv</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">_LatticeInteraction</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objtype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objtype</span> <span class="o">=</span> <span class="n">objtype</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">@</span> <span class="n">opa</span><span class="o">.</span><span class="n">ExpandLattice</span><span class="p">(</span>
            <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="o">=</span><span class="n">kpar</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">kpar</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>

<div class="viewcode-block" id="AcousticTMatrix">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.html#acoustotreams.AcousticTMatrix">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AcousticTMatrix</span><span class="p">(</span><span class="n">AcousticsArray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Acoustic T-matrix with a spherical basis.</span>

<span class="sd">    The acoustic T-matrix is a square matrix relating incident (regular) fields</span>
<span class="sd">    func:`acoustotreams.special.ssw_rPsi` to the corresponding scattered fields </span>
<span class="sd">    :func:`acoustotreams.special.ssw_Psi`. The modes themselves are defined in :attr:`basis`. </span>
<span class="sd">    Moreover, the wave number :attr:`k0` and, if not air, the material :attr:`material` are</span>
<span class="sd">    specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        arr (float or complex, array-like): T-matrix itself.</span>
<span class="sd">        k0 (float): Wave number in air.</span>
<span class="sd">        basis (ScalarSphericalWaveBasis, optional): Basis definition.</span>
<span class="sd">        material (AcousticMaterial, optional): background material, defaults to air.</span>
<span class="sd">        lattice (Lattice, optional): Lattice definition. If specified the T-Matrix is</span>
<span class="sd">            assumed to be periodically repeated in the defined lattice.</span>
<span class="sd">        kpar (list, optional): Bloch wave vector for the effective T-Matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">interaction</span> <span class="o">=</span> <span class="n">_Interaction</span><span class="p">()</span>
    <span class="n">latticeinteraction</span> <span class="o">=</span> <span class="n">_LatticeInteraction</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill in default values or raise errors for missing attributes.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">AnnotationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid shape: &#39;</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">AnnotationError</span><span class="p">(</span><span class="s2">&quot;invalid k0&quot;</span><span class="p">)</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modetype</span>
        <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">modetype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">modetype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modetype</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;singular&quot;</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnnotationError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">SSWB</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">SSWB</span><span class="o">.</span><span class="n">defaultlmax</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wave numbers (in medium).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="p">)</span>

<div class="viewcode-block" id="AcousticTMatrix.sphere">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.sphere.html#acoustotreams.AcousticTMatrix.sphere">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sphere</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">materials</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Acoustic T-Matrix of a sphere.</span>

<span class="sd">        Construct the T-matrix of the given order and material for a sphere. The object</span>
<span class="sd">        can also consist of multiple concentric spherical shells with an arbitrary</span>
<span class="sd">        number of layers.</span>

<span class="sd">        Please note:</span>
<span class="sd">            1. :math:`c_t` of the **last** material must be zero. </span>
<span class="sd">            2. For the soft and hard spheres, only one radius must be given. </span>

<span class="sd">        Args:</span>
<span class="sd">            lmax (int): Non-negative integer for the maximum degree of the T-matrix.</span>
<span class="sd">            k0 (float): Wave number in air.</span>
<span class="sd">            radii (float or array): Radii from inside to outside of the sphere. For a</span>
<span class="sd">                homogeneous sphere the radius can be given as a single number, for a multi-</span>
<span class="sd">                layered sphere it is a list of increasing radii for all shells.</span>
<span class="sd">            material (list[AcousticMaterial]): The material parameters from the inside to the</span>
<span class="sd">                outside. The last material in the list specifies the background medium.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AcousticTMatrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">materials</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isshear</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">radii</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">materials</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incompatible lengths of radii and materials&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">materials</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">materials</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">radii</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;only one radius must be given for soft and hard spheres&quot;</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">SSWB</span><span class="o">.</span><span class="n">defaultdim</span><span class="p">(</span><span class="n">lmax</span><span class="p">)</span>
        <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># noqa: E741</span>
            <span class="n">miecoeffs</span> <span class="o">=</span> <span class="n">mie_acoustics</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">radii</span><span class="p">,</span> <span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">materials</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">SSWB</span><span class="o">.</span><span class="n">defaultdim</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>                                                         
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">tmat</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">miecoeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tmat</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">SSWB</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">lmax</span><span class="p">),</span> <span class="n">material</span><span class="o">=</span><span class="n">materials</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

    
<div class="viewcode-block" id="AcousticTMatrix.cluster">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.cluster.html#acoustotreams.AcousticTMatrix.cluster">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cluster</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tmats</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Block-diagonal T-matrix of multiple objects.</span>

<span class="sd">        Construct the initial block-diagonal T-matrix for a cluster of objects. The</span>
<span class="sd">        T-matrices in the list are placed together into a block-diagonal matrix and the</span>
<span class="sd">        complete (local) basis is defined based on the individual T-matrices and their</span>
<span class="sd">        bases together with the defined positions. In mathematical terms the matrix</span>

<span class="sd">        .. math::</span>

<span class="sd">            \begin{pmatrix}</span>
<span class="sd">                T_0 &amp; 0 &amp; \dots &amp; 0 \\</span>
<span class="sd">                0 &amp; T_1 &amp; \ddots &amp; \vdots \\</span>
<span class="sd">                \vdots &amp; \ddots &amp; \ddots &amp; 0 \\</span>
<span class="sd">                0 &amp; \dots &amp; 0 &amp; T_{N-1} \\</span>
<span class="sd">            \end{pmatrix}</span>

<span class="sd">        is created from the list of T-matrices :math:`(T_0, \dots, T_{N-1})`. Only</span>
<span class="sd">        T-matrices with the same wave number and background material are accepted.</span>

<span class="sd">        Args:</span>
<span class="sd">            tmats (Sequence): List of T-matrices.</span>
<span class="sd">            positions (array): The positions of all individual objects in the cluster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AcousticTMatrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tm</span> <span class="ow">in</span> <span class="n">tmats</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tm</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">isglobal</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;global basis required&quot;</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;specified more positions than T-matrices&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tmats</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; T-matrices &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but only &#39;</span><span class="si">{</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; positions given&quot;</span>
            <span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">tmats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">material</span>
        <span class="n">k0</span> <span class="o">=</span> <span class="n">tmats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">k0</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tmat</span> <span class="ow">in</span> <span class="n">tmats</span><span class="p">)</span>
        <span class="n">tres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmats</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">material</span> <span class="o">!=</span> <span class="n">mat</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;incompatible materials: &#39;</span><span class="si">{</span><span class="n">mat</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">tm</span><span class="o">.</span><span class="n">material</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">k0</span> <span class="o">!=</span> <span class="n">k0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;incompatible k0: &#39;</span><span class="si">{</span><span class="n">k0</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">tm</span><span class="o">.</span><span class="n">k0</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">tm</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">lm</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">pidx</span> <span class="o">+=</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">dim</span>
            <span class="n">tres</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">dim</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">tm</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">dim</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SSWB</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pidx</span><span class="p">,</span> <span class="o">*</span><span class="n">modes</span><span class="p">),</span> <span class="n">positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tres</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span></div>

    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">isglobal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test if a T-matrix is global.</span>

<span class="sd">        A T-matrix is considered global, when its basis refers to only a single point</span>
<span class="sd">        and it is not placed periodically in a lattice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">isglobal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpar</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xs_ext_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Rotation averaged extinction cross section.</span>

<span class="sd">        The average is calculated as</span>

<span class="sd">        .. math::</span>

<span class="sd">            \langle \sigma_\mathrm{ext} \rangle</span>
<span class="sd">            = 2 \pi \sum_{lm} \frac{\Re(T_{lm,lm})}{k^2},</span>

<span class="sd">        where :math:`k` is the wave number in the background medium.    </span>

<span class="sd">        It is only implemented for global T-matrices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or complex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isglobal</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">isreal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">imag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xs_sca_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Rotation averaged scattering cross section.</span>

<span class="sd">        The average is calculated as</span>

<span class="sd">        .. math::</span>

<span class="sd">            \langle \sigma_\mathrm{sca} \rangle</span>
<span class="sd">            = 2 \pi \sum_{lm} \sum_{l&#39;m&#39;}</span>
<span class="sd">            \frac{|T_{lm,l&#39;m&#39;}|^2}{k^2}</span>

<span class="sd">        where :math:`k` is the wave number in the background medium. </span>

<span class="sd">        It is only implemented for global T-matrices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or complex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isglobal</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">isreal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks</span>
        <span class="n">re</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">re</span> <span class="o">*</span> <span class="n">re</span> <span class="o">+</span> <span class="n">im</span> <span class="o">*</span> <span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">k</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">real</span>
    
<div class="viewcode-block" id="AcousticTMatrix.sca">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.sca.html#acoustotreams.AcousticTMatrix.sca">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Expansion coefficients of the scattered field.</span>

<span class="sd">        Possible for all T-matrices (global and local) in non-absorbing background. The</span>
<span class="sd">        coefficients are calculated by</span>

<span class="sd">        .. math::</span>

<span class="sd">            a_{lm} = T_{lm,l&#39;m&#39;} b_{l&#39;m&#39;}</span>

<span class="sd">        where :math:`b_{lm}` are the expansion coefficients of the incident wave</span>
<span class="sd">        and :math:`T` is the T-matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            inc (complex, array): Incident wave or its expansion coefficients</span>

<span class="sd">        Returns:</span>
<span class="sd">            AcousticsArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">AcousticsArray</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc_basis</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">inc_basis</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SSWB</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SSWB</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inc</span><span class="o">.</span><span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">inc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">inc</span></div>

    

<div class="viewcode-block" id="AcousticTMatrix.xs">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.xs.html#acoustotreams.AcousticTMatrix.xs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">xs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Scattering and extinction cross section.</span>

<span class="sd">        Possible for all T-matrices (global and local) in non-absorbing background. The</span>
<span class="sd">        values are calculated by</span>

<span class="sd">        .. math::</span>

<span class="sd">            \sigma_\mathrm{sca}</span>
<span class="sd">            = \frac{1}{2 I}</span>
<span class="sd">            b_{lm}^\ast T_{l&#39;m&#39;,lm}^\ast k^{-2} C_{l&#39;m&#39;,l&#39;&#39;m&#39;&#39;}^{(1)}</span>
<span class="sd">            T_{l&#39;&#39;m&#39;&#39;,l&#39;&#39;&#39;m&#39;&#39;&#39;} b_{l&#39;&#39;&#39;m&#39;&#39;&#39;} \\</span>
<span class="sd">            \sigma_\mathrm{ext}</span>
<span class="sd">            = \frac{1}{2 I}</span>
<span class="sd">            b_{lm}^\ast k^{-2} T_{lm,l&#39;m&#39;} b_{l&#39;m&#39;}</span>

<span class="sd">        where :math:`b_{lm}` are the expansion coefficients of the incident wave,</span>
<span class="sd">        :math:`T` is the T-matrix, :math:`C^{(1)}` is the (regular) translation</span>
<span class="sd">        matrix and :math:`k` is the wave number in the medium. All repeated indices</span>
<span class="sd">        are summed over. The incoming flux is :math:`I`.</span>

<span class="sd">        Args:</span>
<span class="sd">            inc (complex, array): Incident wave or its expansion coefficients</span>
<span class="sd">            flux (optional): Ingoing flux corresponding to the incident wave. Used for</span>
<span class="sd">                the result&#39;s normalization. A plane wave has the flux `0.5` in this </span>
<span class="sd">                normalization, which is used as default.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">isreal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">AcousticsArray</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc_basis</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">inc_basis</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SSWB</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SSWB</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inc</span><span class="o">.</span><span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">):</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">inc</span>
        <span class="n">p_invksq</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">inc</span><span class="o">.</span><span class="n">modetype</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_invksq</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">basis</span><span class="p">))</span> <span class="o">/</span> <span class="n">flux</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">inc</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_invksq</span><span class="p">)</span> <span class="o">/</span> <span class="n">flux</span><span class="p">,</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="AcousticTMatrix.valid_points">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.valid_points.html#acoustotreams.AcousticTMatrix.valid_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">radii</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Points on the grid where the expansion is valid.</span>

<span class="sd">        The expansion of the acoustic wave fields is valid outside of the</span>
<span class="sd">        circumscribing spheres of each object. From a given set of coordinates mark</span>
<span class="sd">        those that are outside of the given radii.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid (array-like): Points to assess. The last dimension needs length three</span>
<span class="sd">                and corresponds to the Cartesian coordinates.</span>
<span class="sd">            radii (Sequence[float]): Radii of the circumscribing spheres. Each radius</span>
<span class="sd">                corresponds to a position of the basis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid grid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid length of &#39;radii&#39;&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">grid</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">res</span></div>

     
<div class="viewcode-block" id="AcousticTMatrix.__getitem__">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrix.__getitem__.html#acoustotreams.AcousticTMatrix.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SSWB</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>
</div>

    

<div class="viewcode-block" id="AcousticTMatrixC">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.html#acoustotreams.AcousticTMatrixC">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AcousticTMatrixC</span><span class="p">(</span><span class="n">AcousticsArray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Acoustic T-matrix with a scalar cylindrical basis.</span>

<span class="sd">    The acoustic T-matrix is a square matrix relating incident (regular) fields</span>
<span class="sd">    :func:`acoustotreams.special.scw_rPsi` to the scattered fields </span>
<span class="sd">    :func:`acoustotreams.special.scw_Psi`. The modes themselves are defined </span>
<span class="sd">    in :attr:`basis`. Moreover, the wave number :attr:`k0` and, if not air, </span>
<span class="sd">    the material :attr:`material` are specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        arr (float or complex, array-like): T-matrix itself.</span>
<span class="sd">        k0 (float): Wave number in air.</span>
<span class="sd">        basis (ScalarCylindricalWaveBasis, optional): Basis definition.</span>
<span class="sd">        material (AcousticMaterial, optional): background material, defaults to air.</span>
<span class="sd">        lattice (Lattice, optional): Lattice definition. If specified the T-Matrix is</span>
<span class="sd">            assumed to be periodically repeated in the defined lattice.</span>
<span class="sd">        kpar (list, optional): Bloch wave vector for the effective T-Matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">interaction</span> <span class="o">=</span> <span class="n">_Interaction</span><span class="p">()</span>
    <span class="n">latticeinteraction</span> <span class="o">=</span> <span class="n">_LatticeInteraction</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill in default values or raise errors for missing attributes.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">AnnotationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid shape: &#39;</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">AnnotationError</span><span class="p">(</span><span class="s2">&quot;invalid k0&quot;</span><span class="p">)</span>
        <span class="n">modetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modetype</span>
        <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">modetype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;singular&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">modetype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modetype</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;singular&quot;</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnnotationError</span><span class="p">(</span><span class="s2">&quot;invalid modetype&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">SCWB</span><span class="o">.</span><span class="n">default</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">SCWB</span><span class="o">.</span><span class="n">defaultmmax</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">material</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wave numbers (in medium).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">krhos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Radial part of the wave vector.</span>

<span class="sd">        Calculate :math:`\sqrt{k^2 - k_z^2}`, where :math:`k` is the wave number in the</span>
<span class="sd">        medium for each insonification.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Sequence[complex]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">krhos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>

<div class="viewcode-block" id="AcousticTMatrixC.cylinder">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.cylinder.html#acoustotreams.AcousticTMatrixC.cylinder">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cylinder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kzs</span><span class="p">,</span> <span class="n">mmax</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">materials</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Acoustic T-Matrix of an infinite cylinder.</span>

<span class="sd">        Construct the T-matrix of the given order and material for an infinite cylinder. </span>
<span class="sd">        The object can also consist of multiple concentric cylindrical shells with an arbitrary</span>
<span class="sd">        number of layers.</span>

<span class="sd">        Please note:</span>
<span class="sd">            1. :math:`c_t` of **all** the materials must be zero. </span>
<span class="sd">            2. For the soft and hard cylinders, only one radius must be given.  </span>

<span class="sd">        Args:</span>
<span class="sd">            kzs (float, array_like): Z component of the cylindrical wave.</span>
<span class="sd">            mmax (int): Positive integer for the maximum order of the T-matrix.</span>
<span class="sd">            k0 (float): Wave number in air.</span>
<span class="sd">            radii (float): Radii from inside to outside of the cylinder. For a</span>
<span class="sd">                homogeneous cylinder the radius can be given as a single number, for a multi-</span>
<span class="sd">                layered cylinder it is a list of increasing radii for all the shells.</span>
<span class="sd">            material (list[AcousticMaterial]): The material parameters from the inside to the</span>
<span class="sd">                outside. The last material in the list specifies the background medium.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AcousticTMatrixC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="p">[</span><span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">materials</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isshear</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">kzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kzs</span><span class="p">)</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">radii</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">materials</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incompatible lengths of radii and materials&quot;</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">SCWB</span><span class="o">.</span><span class="n">defaultdim</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kzs</span><span class="p">),</span> <span class="n">mmax</span><span class="p">)</span>
        <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">kz</span> <span class="ow">in</span> <span class="n">kzs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">mmax</span><span class="p">,</span> <span class="n">mmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">miecoeffs</span> <span class="o">=</span> <span class="n">mie_acoustics_cyl</span><span class="p">(</span><span class="n">kz</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">materials</span><span class="p">))</span>
                <span class="n">tmat</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">miecoeffs</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tmat</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">SCWB</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">kzs</span><span class="p">,</span> <span class="n">mmax</span><span class="p">),</span> <span class="n">material</span><span class="o">=</span><span class="n">materials</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="AcousticTMatrixC.cluster">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.cluster.html#acoustotreams.AcousticTMatrixC.cluster">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cluster</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tmats</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Block-diagonal T-matrix of multiple objects.</span>

<span class="sd">        Construct the initial block-diagonal T-matrix for a cluster of objects. The</span>
<span class="sd">        T-matrices in the list are placed together into a block-diagonal matrix and the</span>
<span class="sd">        complete (local) basis is defined based on the individual T-matrices and their</span>
<span class="sd">        bases together with the defined positions. In mathematical terms the matrix</span>

<span class="sd">        .. math::</span>

<span class="sd">            \begin{pmatrix}</span>
<span class="sd">                T_0 &amp; 0 &amp; \dots &amp; 0 \\</span>
<span class="sd">                0 &amp; T_1 &amp; \ddots &amp; \vdots \\</span>
<span class="sd">                \vdots &amp; \ddots &amp; \ddots &amp; 0 \\</span>
<span class="sd">                0 &amp; \dots &amp; 0 &amp; T_{N-1} \\</span>
<span class="sd">            \end{pmatrix}</span>

<span class="sd">        is created from the list of T-matrices :math:`(T_0, \dots, T_{N-1})`. Only</span>
<span class="sd">        T-matrices with the same wave number and background material</span>
<span class="sd">        can be combined.</span>

<span class="sd">        Args:</span>
<span class="sd">            tmats (Sequence): List of T-matrices.</span>
<span class="sd">            positions (array): The positions of all individual objects in the cluster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AcousticTMatrixC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tm</span> <span class="ow">in</span> <span class="n">tmats</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tm</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">isglobal</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;global basis required&quot;</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;specified more positions than T-matrices&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tmats</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; T-matrices &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but only &#39;</span><span class="si">{</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; positions given&quot;</span>
            <span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">tmats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">material</span>
        <span class="n">k0</span> <span class="o">=</span> <span class="n">tmats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">k0</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tmat</span> <span class="ow">in</span> <span class="n">tmats</span><span class="p">)</span>
        <span class="n">tres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmats</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">material</span> <span class="o">!=</span> <span class="n">mat</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;incompatible materials: &#39;</span><span class="si">{</span><span class="n">mat</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">tm</span><span class="o">.</span><span class="n">material</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">k0</span> <span class="o">!=</span> <span class="n">k0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;incompatible k0: &#39;</span><span class="si">{</span><span class="n">k0</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">tm</span><span class="o">.</span><span class="n">k0</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">tm</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">zm</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">pidx</span> <span class="o">+=</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">dim</span>
            <span class="n">tres</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">dim</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">tm</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">dim</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SCWB</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pidx</span><span class="p">,</span> <span class="o">*</span><span class="n">modes</span><span class="p">),</span> <span class="n">positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tres</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcousticTMatrixC.from_array">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.from_array.html#acoustotreams.AcousticTMatrixC.from_array">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_array</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;1d array of spherical T-matrices.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="p">(</span><span class="n">tm</span> <span class="o">@</span> <span class="n">opa</span><span class="o">.</span><span class="n">Expand</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">inv</span><span class="p">)</span><span class="o">.</span><span class="n">expandlattice</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">),</span>
            <span class="n">lattice</span><span class="o">=</span><span class="n">tm</span><span class="o">.</span><span class="n">lattice</span><span class="p">,</span>
            <span class="n">kpar</span><span class="o">=</span><span class="n">tm</span><span class="o">.</span><span class="n">kpar</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xw_ext_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Rotation averaged extinction cross width.</span>

<span class="sd">        The average is calculated as</span>

<span class="sd">        .. math::</span>

<span class="sd">            \langle \lambda_\mathrm{ext} \rangle</span>
<span class="sd">            = -\frac{2 \pi}{n_{k_z}} \sum_{k_z m} \frac{\Re(T_{k_z m,k_z m})}{k_s}</span>

<span class="sd">        where :math:`k_s` is the wave number in the background medium and :math:`n_{k_z}` </span>
<span class="sd">        is the number of wave components :math:`k_z` included in the T-matrix. </span>
<span class="sd">        The average is taken over all given z-components of the wave vector and </span>
<span class="sd">        rotations around the z-axis. It is only implemented for global T-matrices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or complex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isglobal</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">isreal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks</span> <span class="o">*</span> <span class="n">nk</span><span class="p">)</span>                 
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">imag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">real</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xw_sca_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Rotation averaged scattering cross width.</span>

<span class="sd">        The average is calculated as</span>

<span class="sd">        .. math::</span>

<span class="sd">            \langle \lambda_\mathrm{sca} \rangle</span>
<span class="sd">            = \frac{2 \pi}{n_{k_z}} \sum_{sk_zm} \sum_{s&#39;{k_z}&#39;m&#39;}</span>
<span class="sd">            \frac{|T_{sk_zm,s&#39;{k_z}&#39;m&#39;}|^2}{k_s}</span>

<span class="sd">        where :math:`k_s` is the wave number in the background medium and :math:`n_{k_z}` </span>
<span class="sd">        is the number of wave components</span>
<span class="sd">        :math:`k_z` included in the T-matrix. The average is taken over all given</span>
<span class="sd">        z-components of the wave vector and rotations around the z-axis. It is only</span>
<span class="sd">        implemented for global T-matrices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or complex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isglobal</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">isreal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks</span>
        <span class="n">re</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">re</span> <span class="o">*</span> <span class="n">re</span> <span class="o">+</span> <span class="n">im</span> <span class="o">*</span> <span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ks</span> <span class="o">*</span> <span class="n">nk</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">real</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">isglobal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test if a T-matrix is global.</span>

<span class="sd">        A T-matrix is considered global, when its basis refers to only a single point</span>
<span class="sd">        and it is not placed periodically in a lattice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">isglobal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpar</span> <span class="ow">is</span> <span class="kc">None</span>
    

<div class="viewcode-block" id="AcousticTMatrixC.sca">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.sca.html#acoustotreams.AcousticTMatrixC.sca">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Expansion coefficients of the scattered field.</span>

<span class="sd">        Possible for all T-matrices (global and local) in non-absorbing background. The</span>
<span class="sd">        coefficients are calculated by</span>

<span class="sd">        .. math::</span>

<span class="sd">            a_{k_z m} = T_{k_z m,{k_z}&#39;m&#39;} b_{{k_z}&#39;m&#39;}</span>

<span class="sd">        where :math:`b_{k_z m}` are the expansion coefficients of the incident wave,</span>
<span class="sd">        and :math:`T` is the T-matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            inc (complex, array): Incident wave or its expansion coefficients</span>

<span class="sd">        Returns:</span>
<span class="sd">            AcousticsArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">AcousticsArray</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc_basis</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">inc_basis</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SCWB</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SCWB</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inc</span><span class="o">.</span><span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">inc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">inc</span></div>

        
<div class="viewcode-block" id="AcousticTMatrixC.xw">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.xw.html#acoustotreams.AcousticTMatrixC.xw">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">xw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Scattering and extinction cross width.</span>

<span class="sd">        Possible for all T-matrices (global and local) in non-absorbing background. The</span>
<span class="sd">        values are calculated by</span>

<span class="sd">        .. math::</span>

<span class="sd">            \lambda_\mathrm{sca}</span>
<span class="sd">            = \frac{1}{2 I}</span>
<span class="sd">            b_{k_z m}^\ast T_{{k_z}&#39; m&#39;,k_z m}^\ast k^{-2}</span>
<span class="sd">            C_{{k_z}&#39;m&#39;,{k_z}&#39;&#39;m&#39;&#39;}^{(1)}</span>
<span class="sd">            T_{{k_z}&#39;&#39;m&#39;&#39;,{k_z}&#39;&#39;&#39;m&#39;&#39;&#39;} b_{{k_z}&#39;&#39;&#39;m&#39;&#39;&#39;} \\</span>
<span class="sd">            \sigma_\mathrm{ext}</span>
<span class="sd">            = \frac{1}{2 I}</span>
<span class="sd">            b_{k_z m}^\ast k^{-2} T_{k_z m,{k_z}&#39;m&#39;} b_{{k_z}&#39;m&#39;}</span>

<span class="sd">        where :math:`b_{k_z m}` are the expansion coefficients of the incident wave,</span>
<span class="sd">        :math:`T` is the T-matrix, :math:`C^{(1)}` is the (regular) translation</span>
<span class="sd">        matrix and :math:`k` is the wavenumber in the medium. All repeated indices</span>
<span class="sd">        are summed over. The incoming flux is :math:`I`.</span>

<span class="sd">        Args:</span>
<span class="sd">            inc (complex, array): Incident wave or its expansion coefficients</span>
<span class="sd">            flux (optional): Ingoing flux corresponding to the incident wave. Used for</span>
<span class="sd">                the result&#39;s normalization. A plane wave has the flux `0.5` in this </span>
<span class="sd">                normalization, which is used as default.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">isreal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">AcousticsArray</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">inc_basis</span> <span class="o">=</span> <span class="n">inc_basis</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">inc_basis</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SCWB</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">inc_basis</span><span class="p">,</span> <span class="n">SCWB</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inc</span><span class="o">.</span><span class="n">modetype</span> <span class="o">==</span> <span class="s2">&quot;singular&quot;</span><span class="p">):</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">inc</span>
        <span class="n">p_invksq</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">inc</span><span class="o">.</span><span class="n">modetype</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_invksq</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">basis</span><span class="p">))</span> <span class="o">/</span> <span class="n">flux</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">inc</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_invksq</span><span class="p">)</span> <span class="o">/</span> <span class="n">flux</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AcousticTMatrixC.valid_points">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.valid_points.html#acoustotreams.AcousticTMatrixC.valid_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">radii</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Points on the grid where the expansion is valid.</span>

<span class="sd">        The expansion of the acoustic wave fields is valid outside of the</span>
<span class="sd">        circumscribing cylinders of each object. From a given set of coordinates mark</span>
<span class="sd">        those that are outside of the given radii.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid (array-like): Points to assess. The last dimension needs length two or three</span>
<span class="sd">                and corresponds to the Cartesian coordinates.</span>
<span class="sd">            radii (Sequence[float]): Radii of the circumscribing cylinders. Each radius</span>
<span class="sd">                corresponds to a position of the basis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid grid&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid length of &#39;radii&#39;&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="AcousticTMatrixC.__getitem__">
<a class="viewcode-back" href="../../generated/acoustotreams.AcousticTMatrixC.__getitem__.html#acoustotreams.AcousticTMatrixC.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SCWB</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_plane_wave_partial_scalar</span><span class="p">(</span>
    <span class="n">kpar</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SPWBC</span><span class="o">.</span><span class="n">default</span><span class="p">([</span><span class="n">kpar</span><span class="p">])</span>
    <span class="n">modetype</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">modetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">modetype</span>
    <span class="k">if</span> <span class="n">modetype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid &#39;modetype&#39;: </span><span class="si">{</span><span class="n">modetype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">kzs</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span><span class="o">.</span><span class="n">kzs</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="o">*</span><span class="n">kpar</span><span class="p">)</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">ats</span><span class="o">.</span><span class="n">spw_Psi</span><span class="p">(</span><span class="o">*</span><span class="n">kpar</span><span class="p">,</span> <span class="n">kzs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">pol</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpar</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_plane_wave_scalar</span><span class="p">(</span>
    <span class="n">kvec</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SPWBUV</span><span class="o">.</span><span class="n">default</span><span class="p">([</span><span class="n">kvec</span><span class="p">])</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">kvec</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="n">qvec</span> <span class="o">=</span> <span class="n">kvec</span> <span class="o">/</span> <span class="n">norm</span>
    <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="n">kvec</span> <span class="o">=</span> <span class="n">AcousticMaterial</span><span class="p">(</span><span class="n">material</span><span class="p">)</span><span class="o">.</span><span class="n">ks</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="o">*</span> <span class="n">qvec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kvec</span> <span class="o">=</span> <span class="n">qvec</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">ats</span><span class="o">.</span><span class="n">spw_Psi</span><span class="p">(</span><span class="o">*</span><span class="n">kvec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">pol</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span>
    <span class="p">)</span>


<div class="viewcode-block" id="plane_wave_scalar">
<a class="viewcode-back" href="../../generated/acoustotreams.plane_wave_scalar.html#acoustotreams.plane_wave_scalar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plane_wave_scalar</span><span class="p">(</span>
    <span class="n">kvec</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Array describing a scalar plane wave.</span>

<span class="sd">    Args:</span>
<span class="sd">        kvec (Sequence): Wave vector.</span>
<span class="sd">        basis (ScalarPlaneWaveBasis, optional): Basis definition.</span>
<span class="sd">        k0 (float, optional): Wave number in air.</span>
<span class="sd">        material (AcousticMaterial, optional): Material definition.</span>
<span class="sd">        modetype (str, optional): Mode type (see :ref:`params:Mode types`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_plane_wave_partial_scalar</span><span class="p">(</span>
            <span class="n">kvec</span><span class="p">,</span>
            <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
            <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_plane_wave_scalar</span><span class="p">(</span>
            <span class="n">kvec</span><span class="p">,</span>
            <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
            <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid length of &#39;kvec&#39;: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">kvec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="plane_wave_angle_scalar">
<a class="viewcode-back" href="../../generated/acoustotreams.plane_wave_angle_scalar.html#acoustotreams.plane_wave_angle_scalar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plane_wave_angle_scalar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">qvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">plane_wave_scalar</span><span class="p">(</span><span class="n">qvec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="spherical_wave_scalar">
<a class="viewcode-back" href="../../generated/acoustotreams.spherical_wave_scalar.html#acoustotreams.spherical_wave_scalar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spherical_wave_scalar</span><span class="p">(</span>
    <span class="n">l</span><span class="p">,</span>  <span class="c1"># noqa: E741</span>
    <span class="n">m</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SSWB</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">basis</span><span class="o">.</span><span class="n">isglobal</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;basis must be global&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="n">basis</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="cylindrical_wave_scalar">
<a class="viewcode-back" href="../../generated/acoustotreams.cylindrical_wave_scalar.html#acoustotreams.cylindrical_wave_scalar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cylindrical_wave_scalar</span><span class="p">(</span>
    <span class="n">kz</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SCWB</span><span class="o">.</span><span class="n">default</span><span class="p">([</span><span class="n">kz</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">basis</span><span class="o">.</span><span class="n">isglobal</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;basis must be global&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="n">basis</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">kz</span><span class="p">,</span> <span class="n">m</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">AcousticsArray</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">basis</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">modetype</span><span class="o">=</span><span class="n">modetype</span>
    <span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acoustotreams.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev.html">Development and contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">acoustotreams 0.2.13 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acoustotreams._tmatrixacoustics</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Nikita Ustimenko.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4.
    </div>
  </body>
</html>